package dfki.rdf.util;

import java.util.*;
import org.w3c.rdf.model.*;
import java.lang.reflect.*;


/** Root object of all Java-Objects generated by the {@link RDFS2Class RDFS2Class} tool.
  * <p>
  * Every generated Java object corresponds to a specific RDFS class.
  * If such an RDFS class doesn't have a super class, i.e. has a <code>rdfs:subClassOf</code> link
  * to another RDFS class, then the generated Java class for this RDFS class <code>extends</code>
  * this <code>THING</code> class.
  * <p>
  * This class does already contain some usefull slots and methods, such as for example
  * the getter and putter method of the <code>URI</code> of the corresponding RDF object.
  * <p>
  * @author  Sven.Schwarz@dfki.de
  * @version 1.0
  */
public class THING
{
//----------------------------------------------------------------------------------------------------
/** the <code>URI</code> of the corresponding RDF object
  */
String m_sURI;

//----------------------------------------------------------------------------------------------------
/** Sets the <code>URI</code> of the corresponding RDF object.
  */
public void putURI (String sURI)
{
    m_sURI = sURI;
}

//----------------------------------------------------------------------------------------------------
/** Gets the <code>URI</code> of the corresponding RDF object.
  */
public String getURI ()
{
    return m_sURI;
}

//----------------------------------------------------------------------------------------------------
/** the <code>label</code> of the corresponding RDF object (Protege)
  */
String m_sLabel;

//----------------------------------------------------------------------------------------------------
/** Sets the <code>label</code> of the corresponding RDF object (Protege).
  */
public void putLabel (String sLabel)
{
    m_sLabel = sLabel;
}

//----------------------------------------------------------------------------------------------------
/** Gets the <code>label</code> of the corresponding RDF object (Protege).
  */
public String getLabel ()
{
    return m_sLabel;
}

//----------------------------------------------------------------------------------------------------
/** <code>toString()<code> stuff...
  */
public String toString ()
{
    return toString("");
}

//----------------------------------------------------------------------------------------------------
/** <code>toString()<code> stuff...
  */
public String toString (String sIndent)
{
    return toString_userDefined(sIndent, true);
}

//----------------------------------------------------------------------------------------------------
/** <code>toString()<code> stuff...
  */
public String toString (String sIndent, boolean bIndentDirectly)
{
    StringBuffer sb = new StringBuffer();
    if (bIndentDirectly)
        sb.append(sIndent);
    sb.append(getClassName() + " " + getAddress() + " ");
    if (m_sURI != null)
        sb.append("URI=\"" + m_sURI + "\" ");
//    sb.append("{");
    sb.append("\n");
    toString(sb, sIndent);
//    sb.append(sIndent + "}\n");
    return sb.toString();
}

//----------------------------------------------------------------------------------------------------
/** <code>toString()<code> stuff: <b>this method is overloaded for subclasses of <code>THING</code>!</b>
  */
public void toString (StringBuffer sb, String sIndent)  // overload this method
{
}

//----------------------------------------------------------------------------------------------------
public String toString_userDefined (String sIndent, boolean bIndentDirectly)
{
    return toString(sIndent, bIndentDirectly);
}

//----------------------------------------------------------------------------------------------------
/** <code>toString()<code> stuff: <b>this method can be overloaded for subclasses of <code>THING</code>!</b>
  */
public String toStringShort ()                          // overload this method
{
    return getClassNameShort() + " " +
           getAddress() +
           ( m_sURI != null  ?  " URI=\"" + m_sURI + "\""  :  "");
}

//----------------------------------------------------------------------------------------------------
/** Gets the class name of this object.
  * <br>
  * <b>Note:</b> The method must be declared protected in order to avoid
  * unwanted slot generation when using <code>RDFExport</code> (Java-to-RDF)
  * of Michael Sintek's <code>rdf2java</code> tool
  */
protected String getClassName ()
{
    return getClassNameShort() + " (" + getClass().getName() + ")";
}

//----------------------------------------------------------------------------------------------------
/** Gets a short version (without package) of the class name of this object.
  * <br>
  * <b>Note:</b> The method must be declared protected in order to avoid
  * unwanted slot generation when using <code>RDFExport</code> (Java-to-RDF)
  * of Michael Sintek's <code>rdf2java</code> tool
  */
protected String getClassNameShort ()
{
    String sClassName = getClass().getName();
    int pos = sClassName.lastIndexOf('.');
    if (pos >= 0)
        return sClassName.substring(pos+1);
    else
        return sClassName;
}

//----------------------------------------------------------------------------------------------------
/** Gets a string showing the address of this object in hex notation.
  * <br>
  * The string is prefixed with a <code>'@'</code> character.<br>
  * <b>Note:</b> The method must be declared protected in order to avoid
  * unwanted slot generation when using <code>RDFExport</code> (Java-to-RDF)
  * of Michael Sintek's <code>rdf2java</code> tool
  */
protected String getAddress ()
{
    return "@" + Integer.toHexString(this.hashCode());
}

//----------------------------------------------------------------------------------------------------
/** Gets a string showing the address of this object in hex notation.
  * <br>
  * The string is <b>not</b> prefixed with a <code>'@'</code> character.<br>
  * <b>Note:</b> The method must be declared protected in order to avoid
  * unwanted slot generation when using <code>RDFExport</code> (Java-to-RDF)
  * of Michael Sintek's <code>rdf2java</code> tool
  */
protected String getAddressOnlyHex ()
{
    return Integer.toHexString(this.hashCode());
}

//----------------------------------------------------------------------------------------------------
/** Creates a new URI (with default namespace) and {@link #putURI stores} this URI in this object.
  */
public void makeNewURI ()
{
    Date date = new Date();
    String sNewURI = "http://dfki.frodo/default#" + "id_" + date.getTime() + "_" + getAddressOnlyHex();
    putURI(sNewURI);
}

//----------------------------------------------------------------------------------------------------
/** Creates a new URI (with given namespace) and {@link #putURI stores} this URI in this object.
  */
public void makeNewURI (String sNamespace)
{
    Date date = new Date();
    String sNewURI = sNamespace + "id_" + date.getTime() + "_" + getAddressOnlyHex();
    putURI(sNewURI);
}

//----------------------------------------------------------------------------------------------------
/** Creates a new URI for this object, stores it in the object and in the given map.
  */
public void addToMap (Map mapObjects, String sNamespace)
{
    try {
        makeNewURI(sNamespace);
        Resource resNewURI = dfki.util.rdf.RDF.factory().getNodeFactory().createResource(getURI());
        mapObjects.put(resNewURI, this);
    }
    catch (Exception ex)
    {
        System.out.println("Exception occurred: "+ex.getMessage());
        ex.printStackTrace();
        throw new Error(ex.getMessage());
    }
}

//----------------------------------------------------------------------------------------------------
/** Creates a new URI for this object, stores it in the object and in the given map.
  */
public void addToMap (Map mapObjects)
{
    addToMap(mapObjects, "http://dfki.frodo/default#");
}

//----------------------------------------------------------------------------------------------------
public boolean equals (Object other)
{
    // objects are hereby declared as identical iff their URIs are equal
    if (other instanceof THING)
    {
        if (m_sURI != null && ((THING)other).m_sURI != null)
            return m_sURI.equals(((THING)other).m_sURI);
        else
            return false;  // sorry, no chance left :-(
    }
    else
    if (other instanceof org.w3c.rdf.model.Resource)
    {
        try { return m_sURI.equals(((org.w3c.rdf.model.Resource)other).getURI()); }
        catch (Exception ex) { return false; }
    }
    else
        return false;
}

//----------------------------------------------------------------------------------------------------
public void updateRDFResourceSlots (dfki.rdf.util.KnowledgeBase kbCachedObjects)
{
    Method[] aMethods = getClass().getMethods();
    for (int i = 0; i < aMethods.length; i++)
    {
        Method method = aMethods[i];
        String sMethodName = method.getName();
        if (!sMethodName.startsWith("Get") || !sMethodName.endsWith("__asURI"))
            continue;
        Class[] aParameterTypes = method.getParameterTypes();
        if (aParameterTypes.length > 0)
            continue;
        Object objPropValueAsURI = null;
        try {
            objPropValueAsURI = method.invoke(this, null);
        } catch (Exception ex) {
            System.out.println("dfki.rdf.util.THING . updateRDFResourceSlots: Exception occurred" + ex);
        }
        if (objPropValueAsURI == null) continue;
        String sPropertyName = calcMethodNameToPropertyName(sMethodName);
        String sPutMethodName = calcPropertyNameToMethodNameWithoutURI(sPropertyName);
        if (objPropValueAsURI instanceof dfki.rdf.util.RDFResource)
        {
            try {
                Object cachedObject = kbCachedObjects.get(objPropValueAsURI);
                if (cachedObject == null || (cachedObject instanceof dfki.rdf.util.RDFResource)) continue;
                Method methodPutterNormal = getClass().getMethod( sPutMethodName, new Class[] { cachedObject.getClass() } );
                Method methodPutterURI = getClass().getMethod( sPutMethodName, new Class[] { dfki.rdf.util.RDFResource.class } );
                methodPutterNormal.invoke( this, new Object[] { cachedObject } );
                methodPutterURI.invoke( this, new Object[] { null } );
            }
            catch (Exception ex) {
                throw new Error(ex.getMessage());
            }
        }
        else
        if (objPropValueAsURI instanceof java.util.Collection)
        {
            try {
                for (Iterator itURIs = ((java.util.Collection)objPropValueAsURI).iterator(); itURIs.hasNext(); )
                {
                    dfki.rdf.util.RDFResource uri = (dfki.rdf.util.RDFResource)itURIs.next();
                    Object cachedObject = kbCachedObjects.get(uri);
                    if (cachedObject == null || (cachedObject instanceof dfki.rdf.util.RDFResource)) continue;
                    Method methodPutterNormal = getClass().getMethod( sPutMethodName, new Class[] { cachedObject.getClass() } );
                    methodPutterNormal.invoke( this, new Object[] { cachedObject } );
                    itURIs.remove();
                }
            }
            catch (Exception ex) {
                throw new Error(ex.getMessage());
            }
        }
        else
            throw new Error("Wrong class for objValue in dfki.rdf.util.THING . updateRDFResourceSlots");
    }
}

String calcMethodNameToPropertyName (String sMethodName)
{
    // GetXXYYZZ__asURI --> XXYYZZ
    if (sMethodName.startsWith("Get_"))
        return sMethodName.substring(4, sMethodName.length()-7);
    else
        return Character.toLowerCase(sMethodName.charAt(3)) + sMethodName.substring(4, sMethodName.length()-7);
}

String calcPropertyNameToMethodNameWithoutURI (String sPropName)
{
    if (Character.isLowerCase(sPropName.charAt(0)))
        return "put"  + Character.toUpperCase(sPropName.charAt(0))
                      + sPropName.substring(1); // + "__asURI";
    else
        return "put_" + sPropName; // + "__asURI";
}

//----------------------------------------------------------------------------------------------------
}

